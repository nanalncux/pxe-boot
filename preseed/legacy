d-i debian-installer/language string en
d-i debian-installer/country string RU
d-i debian-installer/locale string en_US.UTF-8
d-i localechooser/supported-locales en_US.UTF-8, ru_RU.UTF-8

# Set Keyboard
d-i console-keymaps-at/keymap select us
d-i keyboard-configuration/xkb-keymap select us

# Set hostname
d-i netcfg/hostname string Hawking

### Mirror settings
d-i mirror/country string manual
d-i mirror/http/hostname string mirror.selectel.ru
d-i mirror/http/directory string /ubuntu
d-i mirror/http/proxy string

# TEMP install linux-image-4.4.0-142-generic # BUG: https://bugs.launchpad.net/ubuntu/+source/linux/+bug/1820366


d-i apt-setup/non-free boolean true
d-i apt-setup/security-updates  boolean true
d-i apt-setup/services-select multiselect security
d-i apt-setup/security_host string mirror.selectel.ru
d-i apt-setup/security_path string /ubuntu



### Account setup to change
d-i passwd/make-user boolean false
d-i passwd/root-password-crypted password .dxebGBoGm9Xq6YIL5mu6v7L8
d-i passwd/root-login boolean true
d-i user-setup/allow-password-weak boolean true
d-i user-setup/encrypt-home boolean false


### Clock and time zone setup
d-i clock-setup/utc boolean true
d-i time/zone string Europe/Moscow
d-i clock-setup/ntp boolean true
d-i clock-setup/ntp-server string ntp1.selectel.org


### Partitioning
# or boot with nodmraid
disk-detect disk-detect/activate_dmraid boolean false
d-i hw-detect/load_firmware boolean true
# Partman confirmatios
d-i partman-efi/non_efi_system boolean true

d-i partman-md/confirm boolean true
d-i partman-md/device_remove_md boolean true
d-i partman-md/confirm_nooverwrite boolean true
d-i partman-partitioning/confirm_write_new_label boolean true
d-i partman/choose_partition select finish
d-i partman/confirm boolean true
d-i partman/confirm_nooverwrite boolean true
d-i partman-lvm/confirm_nooverwrite boolean true
d-i partman-lvm/confirm boolean true
d-i partman-lvm/device_remove_lvm boolean true
d-i partman-lvm/device_remove_lvm_span boolean true
d-i partman-auto-lvm/guided_size string max
d-i partman-auto-lvm/new_vg_name string vg0
d-i partman-basicfilesystems/no_swap boolean false
d-i mdadm/boot_degraded boolean true
d-i partman-basicfilesystems/choose_label string gpt
d-i partman-basicfilesystems/default_label string gpt
d-i partman-partitioning/choose_label string gpt
d-i partman-partitioning/default_label string gpt
d-i partman/choose_label string gpt
d-i partman/default_label string gpt

### clear all disks
d-i partman/early_command string 
mdadm --assemble --scan; sleep 2;pvscan; sleep 2;vgchange -an; sleep 2;
for i in ; dopvremove -ff -y ;done;sleep 2;mdadm --stop --scan; sleep 2;
for i in /dev/nvme0
/dev/nvme0n1
/dev/nvme0n1p1
/dev/nvme0n1p2
/dev/nvme0n1p3
/dev/nvme0n1p4
/dev/sda
/dev/sda1; doif ; thenmdadm --zero-superblock ;fi;done;sleep 2;

### IPMI usb device hack
## hack to use only valid block devices
for i in ; dodrive=;if [ -f /sys/block/""/device/vendor ] && [  == "IPMI" -o  == "AMI" -o  == "Generic-" ]; thencontinue;elsedd if=/dev/zero of= bs=1M count=10;blockdev --rereadpt ;num=1;eval "disk=" ;if [ "" != "" ]; then eval "diskp=p"; else eval "diskp="; fi;fi;done;sleep 2;debconf-set grub-installer/bootdev "";debconf-set preseed/late_command "mount -t efivarfs efivars /sys/firmware/efi/efivars ;
mount -o bind /sys  /target/sys  ;mount -o bind /dev  /target/dev  ;mount -o bind /proc /target/proc ;### HACK TO FIX BUG: https://bugs.launchpad.net/ubuntu/+source/grub-installer/+bug/1880855
### It also required to skip the GRUB Install stage.
mount -t efivarfs efivars /target/sys/firmware/efi/efivars;in-target apt update ;in-target apt install -y grub-efi-amd64 ;in-target grub-install ;
in-target sed -i '/GRUB_CMDLINE_LINUX_DEFAULT/s/quiet/quiet nomodeset/g' /etc/default/grub ;in-target grub-mkconfig -o /boot/grub/grub.cfg ;
in-target wget 'http://pxe.ds.selectel.org/v2/boot/public/c453e7ad-a7a4-40e8-8919-4e661f6a2c07/template?stage=postinstall&uefi=True' -O /tmp/postinstall.sh ;
in-target /bin/bash /tmp/postinstall.sh ;";
# RAID type depend start


debconf-set partman-auto/disk " ";debconf-set partman-auto-raid/recipe "     0 2 0 ext3 /boot 4#4 .              0 2 0 ext4 / 5#5 .  "

d-i partman-auto/method string raid
d-i partman-auto/choose_recipe select boot-root
d-i partman-auto/expert_recipe string boot-root ::     2 2 2 free { } method{ biosgrub } .     256 256 256 free { gpt } method{ efi } format{ } .     5120 10 5120 linux-swap { } method{ swap } format{ } .     1024 1024 1024 raid { } { } method{ raid } .                 9000 1000 -1 raid { } { } method{ raid } .               5120 10 5120 linux-swap { } { } method{ swap } format{ } .               2000 1000 -1 ext4 { } { } method{ format } format{ } use_filesystem{ } filesystem{ ext4 } mountpoint{ / } .


### Apt setup
d-i apt-setup/non-free boolean true
d-i apt-setup/contrib boolean true


### Package selection
d-i pkgsel/update-policy select unattended-upgrades
d-i pkgsel/include string openssh-server ntp dkms jq lshw efibootmgr
d-i pkgsel/upgrade select none
d-i pkgsel/update-policy select none
popularity-contest popularity-contest/participate boolean false
tasksel tasksel/first multiselect standard
postfix postfix/main_mailer_type        select  No configuration
postfix postfix/destinations    string  Hawking, localhost
postfix postfix/recipient_delim string  +
postfix postfix/procmail        boolean true
postfix postfix/mailbox_limit   string  0
postfix postfix/mynetworks      string  127.0.0.0/8 [::ffff:127.0.0.0]/104 [::1]/128
postfix postfix/mailname        string  Hawking
postfix postfix/relayhost       string


### GRUB Install
### HACK TO FIX BUG: https://bugs.launchpad.net/ubuntu/+source/grub-installer/+bug/1880855
### It require to install grub in manual mode. Look it up in d-i late_command.
d-i grub-installer/skip boolean true
d-i nobootloader/confirmation_common note



### Finishing up the installation
d-i finish-install/keep-consoles boolean true
d-i finish-install/reboot_in_progress note
d-i cdrom-detect/eject boolean false

